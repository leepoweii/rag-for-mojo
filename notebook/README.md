# 夢酒館 RAG 品牌大使 - Jupyter Notebook 原始作業版本

這是我繳交學校作業時的 Jupyter Notebook 版本，保留了原始的開發過程和思考脈絡。

## 關於這個作業

我在金門開了一間酒吧叫做夢酒館，這個 RAG 系統原本是學校的作業專案。

### 專案起源

當時剛好在撰寫金門的補助案，發現申請政府案子時常需要重複整理公司資訊。因此在做作業時想到可以建立 RAG 內部資料集，未來可根據不同專案快速提取資料並整合撰寫計劃書。

不過考慮到作業展示的需求，將機器人定位調整為「品牌大使」，這樣分享給朋友體驗時會比較有趣，也更貼近實際應用場景。

### 關於這個版本

這是我最初繳交作業時使用的 Jupyter Notebook 版本：
- 包含完整的開發筆記和思考過程
- 使用 Gradio 快速驗證概念
- 適合想了解 RAG 系統原理的人參考

## 目前資料庫內容

1. 品牌介紹
2. 調酒酒單介紹
3. 相關媒體報導

## 發現比較大的問題與解法

### 複合式問句問題
**發現問題**: RAG 系統一次只能處理單一問題，對於包含多個子句的複合式問句，無法精確理解並提供完整答案。

**目前解法**: 為了解決這個問題，利用 LLM 先將複合式問句拆解成多個子問題，分別進行檢索，最後再整合所有答案。

### 內容組合錯誤（Limitations）

**問題描述**:
由於 RAG 系統將內容切割成 chunks 進行向量檢索，在檢索過程中，偶爾會出現內容組合錯誤的情況。例如，詢問 A 調酒時可能混入 B 調酒的描述片段，導致回答內容不一致。

**未來研究方向（Future Work）**:

本專案識別出以下可能的改進方向，供未來研究探索：

1. **結構化資料綁定方法**
   探索將向量化 chunks 與結構化 metadata（如內容 ID、分類標籤）綁定的可行性，以維持語意檢索的靈活性同時保留資料完整性。

2. **檢索後意圖過濾機制**
   研究在檢索階段引入輕量級分類器或小型 LLM，對檢索結果進行意圖判斷與過濾，可能有助於提升結果的一致性。

3. **混合檢索策略**
   結合向量檢索與關鍵字檢索（如 BM25），或探索 GraphRAG 等新興方法，可能為此問題提供新的解決思路。

**現狀說明**: 因本專案為學校作業性質，上述方向僅為初步構想，尚未進行嚴格的實驗驗證。未來若應用於生產環境，建議針對具體使用場景進行深入研究與測試。

### LLM 多次調用成本考量（Limitations）

**問題描述**:
目前系統設計中，LLM 被多次用於不同處理階段：
1. **查詢拆解階段**: 使用 LLM 將複合問句分解為子問題
2. **答案整合階段**: 使用 LLM 整合檢索結果並生成最終回答

雖然使用的是小模型（GPT-4.1 Nano），單次調用速度不慢，但多次調用會產生累積的成本負擔。對於高頻使用場景，這可能成為營運上的限制。

**現狀說明**: 本專案為研究性質，優先驗證 RAG 技術可行性。目前尚未找到在不犧牲語意理解品質的前提下，有效降低 LLM 調用次數的方法。此為已知限制，未來需根據實際使用量和預算進行權衡取捨。

## 技術架構

### 重新設計的檢索和回答流程

1. **語意拆解**: 使用大型語言模型（LLM）將使用者輸入的複合式問題，拆解成多個語意清晰、可獨立檢索的子問題。
2. **個別檢索**: 針對每個拆解後的子問題，分別從知識庫中檢索相關文件。
3. **整合回答**: 根據原始問句，以及步驟二中檢索到的所有相關文件，使用 LLM 整合生成最終的完整回覆。

### 核心技術
- **語意拆解**: 自訂 prompt 透過 OpenAI GPT-4.1 Nano 將複合問句拆解成子問題
- **向量檢索**: 自訂 E5 embedding 類別 + FAISS 向量資料庫
- **檢索策略**: 使用 top k = 3 讓資料更完整
- **UI**: Gradio 快速打造 Web App

## 快速開始

### 環境設置

```bash
# 安裝 uv（如果還沒安裝）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 安裝依賴
uv sync

# 設置環境變數
cp .env.example .env
# 編輯 .env 添加你的 OpenAI API Key
```

### 運行專案

```bash
# 啟動 Jupyter Notebook
uv run jupyter notebook

# 打開 酒吧RAG品牌大使.ipynb 並執行

# 或者直接在 VS Code 執行也可以
```

## 使用示範

### 測試案例
```python
user_input = "我喜歡清爽氣泡的調酒，請你推薦我一杯調酒。同時也請你跟我說明夢酒館在地方所做的貢獻，還有夢酒館登過的國際媒體報導。"
```

### 系統處理流程
1. **語意拆解結果**:
   - 子問句1：我喜歡清爽氣泡的調酒。
   - 子問句2：請你推薦我一杯調酒。
   - 子問句3：請你跟我說明夢酒館在地方所做的貢獻。
   - 子問句4：請你說明夢酒館登過的國際媒體報導。

2. **個別檢索**: 針對每個子句分別檢索相關資料

3. **整合回答**: 根據原始問句整合生成完整回覆

## 技術細節

### 自訂 E5 Embedding 類別
```python
class CustomE5Embedding(HuggingFaceEmbeddings):
    def embed_documents(self, texts):
        texts = [f"passage: {t}" for t in texts]
        return super().embed_documents(texts)

    def embed_query(self, text):
        return super().embed_query(f"query: {text}")
```

### 語意拆解系統
使用專門設計的 system prompt，讓 AI 工具能夠：
- 識別複合問句中的多個子句
- 拆解成可獨立檢索的子問題
- 保持原始語意不被改寫

### 品牌大使設定
系統設定為「把夢酒館介紹給旅客的品牌大使」，具備：
- 雞尾酒專業知識
- 地方文化策展力
- 溫暖專業的回答語氣

## 專案結構

```
notebook/
├── 酒吧RAG品牌大使.ipynb    # 主要實作內容
├── faiss_db/                # FAISS 向量資料庫
├── .env.example             # 環境變數範例
├── pyproject.toml           # uv 專案配置
└── README.md                # 本說明文件
```

## 相關專案

- **展示版本**: 請參考根目錄或 `/app` 資料夾，包含我後來開發的 Flask Web 應用程式展示版本

## 作業省思與未來改善空間

這個作業讓我驗證了 RAG 技術的可行性，但也發現了一些可以改進的地方：

1. 內容組合錯誤問題（向量檢索偶爾會混淆相似內容）
2. Chunking 策略可以更精細
3. 缺乏評估機制來量化系統表現
4. 程式碼結構可以更模組化

不過因為這是學校作業性質，目前就先到這裡了。
